# PRD: generate-layout-image コマンド

## 概要

`generate-layout-image` コマンドは、extract-pageで抽出したPNG画像とextract-layoutで抽出したレイアウト情報を組み合わせ、レイアウト解析結果を視覚的に確認できるPNG画像を生成します。

## 機能仕様

### 基本機能

- 元のPNG画像にレイアウト解析結果（バウンディングボックス）を重ねた新しい画像を生成
- 植物の写真領域と説明領域を異なる色で区別して表示
- 植物名ラベルの表示
- エラー時は元画像にエラーメッセージをオーバーレイ

### 入力

#### 必須引数
- `<input>`: PNGファイルまたはPNGファイルが格納されたディレクトリ

#### オプション引数
- `--layout-dir <dir>`: レイアウトJSONファイルの格納ディレクトリ（デフォルト: 入力と同じディレクトリ）
- `--output-dir <dir>`: 出力先ディレクトリ（デフォルト: 入力と同じディレクトリ）

### 出力

#### 成功時
- ファイル名: `${baseName}_layout.png`
- 内容: 元画像 + バウンディングボックス + 植物名ラベル

#### エラー時
- ファイル名: `${baseName}_layout.png`
- 内容: 元画像 + エラーメッセージオーバーレイ

### レイアウト表示仕様

#### バウンディングボックス
- 写真領域: 緑色の枠線（`#00FF00`）
- 説明領域: 青色の枠線（`#0000FF`）
- 線の太さ: 3px
- 透明度: 80%

#### 植物名ラベル
- 位置: 各植物の最初の写真領域の上部
- 背景: 半透明の白色背景
- フォント: Arial Bold, 24px
- 文字色: 黒色

#### 複数領域の処理
- 同一植物の複数の写真/説明領域には番号を付与しない
- すべての領域に同じ色の枠線を適用

## エラーハンドリング

### JSONファイル関連エラー
- JSONファイルが存在しない場合
- JSONファイルの内容が不正な場合
- JSONファイルのバリデーションエラー

**処理方法:**
1. エラー内容をログに出力
2. 元画像に赤い背景でエラーメッセージをオーバーレイ
3. 処理を継続（他のファイルの処理に影響しない）

### 画像ファイル関連エラー
- 画像ファイルが破損している場合
- 画像ファイルが読み込めない場合

**処理方法:**
1. エラー内容をログに出力
2. そのファイルの処理をスキップ
3. 処理を継続

## 技術仕様

### 使用技術
- **画像処理ライブラリ**: Sharp
- **Canvas描画**: node-canvas
- **ファイル処理**: Node.js標準ライブラリ

### 処理フロー
1. 入力パスの解析（ファイル/ディレクトリ判定）
2. 対象PNGファイルの一覧取得
3. 各PNGファイルに対して：
   a. 対応するJSONファイルの存在確認
   b. JSONファイルの読み込み・バリデーション
   c. 元画像の読み込み
   d. Canvas作成・バウンディングボックス描画
   e. 結果画像の保存
4. 処理結果のサマリー表示

### ファイル命名規則
- **入力PNG**: `example.png`
- **レイアウトJSON**: `example_layout.json`
- **出力PNG**: `example_layout.png`

### 進捗表示
- 処理対象ファイル数の表示
- 各ファイルの処理開始/完了ログ
- 処理完了時のサマリー（成功/エラー/スキップ件数）

## コマンド例

```bash
# ディレクトリ内の全PNGファイルを処理
npm run generate-layout-image ./images

# 単一ファイルを処理
npm run generate-layout-image ./images/book_001.png

# レイアウトJSONファイルが別ディレクトリにある場合
npm run generate-layout-image ./images --layout-dir ./layouts

# 出力先を指定
npm run generate-layout-image ./images --output-dir ./output
```

## 非機能要件

### パフォーマンス
- 大量ファイル処理時のメモリ使用量制御
- 画像処理の最適化

### 保守性
- extract-layoutコマンドと共通の型定義・バリデーション機能を使用
- 既存のlogger機能を活用

### 拡張性
- バウンディングボックスの色・スタイル設定の外部化に対応可能な設計
- 将来的なレイアウト形式変更に対応可能な設計