# PRD: extract-layout

## 1. 概要

### 目的

extract-pageで抽出した草木図鑑のPNGファイルをレイアウト解析し、各草木の写真と説明文の領域を特定してJSONファイルとして出力します。

### 対象ユーザー

- 開発者個人

## 2. 機能要求

### 必須機能（Must Have）

- [ ] コマンドラインプログラムとして動作
- [ ] PNGディレクトリ内の全ファイルを一括処理
- [ ] Google Gemini 2.5 Flash APIを使用したレイアウト解析
- [ ] 各草木の写真領域と説明文領域の座標を抽出
- [ ] JSON形式での結果出力
- [ ] 出力JSONのバリデーション機能
- [ ] 処理済みファイルのスキップ機能

### 推奨機能（Should Have）

- [ ] レート制限への対応（API呼び出し間隔調整）
- [ ] 進捗表示
- [ ] エラー時の自動リトライ

### 任意機能（Could Have）

- [ ] 並行処理（レート制限内で）
- [ ] 設定ファイル対応（プロンプト調整等）

## 3. 技術仕様

### 入力

- pngDirectory: 解析対象のPNGファイルが格納されたディレクトリパス

### 出力

- 各PNGファイルに対応する`${元ファイル名}_layout.json`ファイル

### 出力JSON形式

```json
{
  "page": "filename.png",
  "plants": [
    {
      "name": "ヨモギ",
      "photoAreas": [
        {"x": 100, "y": 100, "width": 500, "height": 200}
      ],
      "descriptionAreas": [
        {"x": 100, "y": 320, "width": 500, "height": 150}
      ]
    }
  ]
}
```

### 処理フロー

1. PNGディレクトリ内のファイル一覧を取得
2. 各PNGファイルに対して：
   - 対応するlayout.jsonが存在し、内容が有効な場合はスキップ
   - Google Gemini APIに画像とプロンプトを送信
   - レスポンスをパース・バリデーション
   - JSON形式で保存
   - レート制限を考慮した待機
3. 処理完了の報告

### プロンプト設計

- 1ページに2-6個の草木が含まれることを明示
- 各草木の名前、写真領域、説明文領域の抽出を指示
- 座標形式（x, y, width, height）を指定
- 認識できない場合は"unknown"とする指示

## 4. 実装詳細

### 使用技術

- TypeScript で書くこと
- コマンドラインパーサとして Commander を利用
- Google Gemini API 連携
- dotenv で環境変数管理
- winston でログを取ること
- JSON Schema バリデーション

### 環境変数

```
GEMINI_API_KEY=your_api_key_here
```

### ファイル構成

```
src/
├── commands/
│   └── extract-layout.ts
├── utils/
│   ├── gemini-client.ts
│   ├── json-validator.ts
│   └── rate-limiter.ts
└── types/
    └── layout-types.ts
```

### エラーハンドリング

- 植物名を認識できない場合：`"name": "unknown"`として出力
- API呼び出し失敗：リトライ機能（最大3回）
- 不正なJSON応答：エラーログ出力後、該当ファイルをスキップ
- ファイルI/Oエラー：エラーログ出力後、処理継続

### バリデーション仕様

- 必須フィールド：`page`, `plants`
- `plants`は配列で、各要素は`name`, `photoAreas`, `descriptionAreas`を含む
- 座標は正の数値のみ許可
- 空配列は許可（写真や説明がない場合）

## 5. テスト要件

### 単体テスト

- JSON バリデーション機能のテスト
- レート制限機能のテスト
- ファイルスキップ機能のテスト

### 統合テスト

- Gemini API モックを使用した全体フローテスト
- 実際のPNGファイルを使用したE2Eテスト

## 6. 成功基準

- 全PNGファイルが正常に解析される
- 出力JSONが仕様に準拠している
- 処理済みファイルが適切にスキップされる
- レート制限が遵守される

## 7. リスク・制約

### 技術的リスク

- Gemini API の利用制限・コスト
- AI による認識精度の変動
- ネットワークエラー

### 制約事項

- Google Gemini API の利用規約に準拠
- レート制限内での処理
- 図鑑のレイアウト変更への依存