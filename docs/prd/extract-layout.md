# PRD: extract-layout

## 1. 概要

### 目的

extract-pageで抽出した草木図鑑のPNGファイルをレイアウト解析し、各草木の写真と説明文の領域を特定してJSONファイルとして出力します。

### 対象ユーザー

- 開発者個人

## 2. 機能要求

### 必須機能（Must Have）

- [ ] コマンドラインプログラムとして動作
- [ ] PNGディレクトリ内の全ファイルを一括処理
- [ ] パターンマッチングによるレイアウト認識
- [ ] エッジ検出による高精度なパターン判定
- [ ] 領域分割による写真・説明部分の分離
- [ ] Google Gemini APIを使用したOCR処理
- [ ] 各草木の写真領域と説明文領域の座標を抽出
- [ ] 植物名と説明文全体の抽出
- [ ] JSON形式での結果出力
- [ ] 出力JSONのバリデーション機能
- [ ] 処理済みファイルのスキップ機能

### 推奨機能（Should Have）

- [ ] レート制限への対応（API呼び出し間隔調整）
- [ ] 進捗表示
- [ ] エラー時の自動リトライ
- [ ] パターンマッチング失敗時のフォールバック

### 任意機能（Could Have）

- [ ] 並行処理（レート制限内で）
- [ ] 設定ファイル対応（エッジ検出閾値調整等）

## 3. 技術仕様

### 解析アプローチ

新しい3段階解析方式を採用：

1. **パターンマッチング**: エッジ検出により画像が事前定義されたレイアウトパターンのどれに該当するかを判定
2. **領域分割**: マッチしたパターンに基づいて各ボックスを写真部分と説明部分に分割
3. **OCR処理**: 説明部分をGemini APIでOCR処理し、植物名と説明文を抽出

### 対応レイアウトパターン

#### ODD_3ROWS（奇数ページ3行レイアウト）
- ボックス数: 3個
- 各ボックス分割: 左628px（説明） | 右側残り（写真）
- 座標: `[{x:225, y:119, w:1110, h:567}, {x:225, y:702, w:1110, h:577}, {x:225, y:1298, w:1110, h:573}]`

#### EVEN_3ROWS（偶数ページ3行レイアウト）
- ボックス数: 3個
- 各ボックス分割: 左463px（写真） | 右側残り（説明）
- 座標: `[{x:288, y:83, w:1096, h:577}, {x:288, y:678, w:1096, h:569}, {x:288, y:1267, w:1096, h:569}]`

#### ODD_2ROWS（奇数ページ2行レイアウト）
- ボックス数: 2個
- 各ボックス分割: 左628px（説明） | 右側残り（写真）
- 座標: `[{x:215, y:90, w:1096, h:843}, {x:215, y:979, w:1096, h:843}]`

### 入力

- pngDirectory: 解析対象のPNGファイルが格納されたディレクトリパス

### 出力

- 各PNGファイルに対応する`${元ファイル名}_layout.json`ファイル

### 出力JSON形式

```json
{
  "page": "filename.png",
  "plants": [
    {
      "name": "ヨモギ",
      "photoAreas": [
        {"x": 891, "y": 119, "width": 444, "height": 567}
      ],
      "descriptionAreas": [
        {"x": 225, "y": 119, "width": 628, "height": 567}
      ],
      "descriptionText": "ヨモギ\nキク科\n多年生草本。高さ50-120cm。茎は直立し、よく分枝する。葉は互生し、羽状に深裂する..."
    }
  ]
}
```

### 処理フロー

1. **ファイル取得**: PNGディレクトリ内のファイル一覧を取得
2. **各PNGファイルに対して**:
   - 対応するlayout.jsonが存在し、内容が有効な場合はスキップ
   - **パターンマッチング**: Sharp + Sobelフィルタでエッジ検出し、パターンを判定
   - **画像分割**: マッチしたパターンの分割ルールに従って各ボックスを写真/説明に分割
   - **OCR処理**: 説明部分をGemini APIでOCR処理
   - **植物名抽出**: OCR結果の最初の行から植物名を抽出
   - **結果統合**: LayoutResult形式でJSONを構築
   - レート制限を考慮した待機
3. **処理完了報告**

### エッジ検出アルゴリズム

```typescript
// Sobelフィルタによるエッジ検出
const sobelKernel = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
const edges = await sharp(imagePath)
  .greyscale()
  .convolve({
    width: 3,
    height: 3,
    kernel: sobelKernel
  });

// 境界線上のエッジ密度を計算
const edgeDensity = await calculateBoundaryEdgeDensity(edges, pattern.boxes);
```

### OCRプロンプト設計

```
この画像に含まれるテキストを抽出してください。
最初の行は植物名として扱います。
出力形式：
植物名: [最初の行のテキスト]
説明文: [全体のテキスト]
```

## 4. 実装詳細

### 使用技術

- TypeScript で書くこと
- コマンドラインパーサとして Commander を利用
- Sharp による画像処理（エッジ検出、領域切り出し）
- Google Gemini API 連携（OCR処理）
- dotenv で環境変数管理
- winston でログを取ること
- JSON Schema バリデーション

### 環境変数

```
GEMINI_API_KEY=your_api_key_here
```

### ファイル構成

```
src/
├── commands/
│   └── extract-layout.ts
├── utils/
│   ├── pattern-matcher.ts      # 新規：エッジ検出+パターンマッチング
│   ├── image-splitter.ts       # 新規：画像分割処理
│   ├── gemini-client.ts        # 更新：OCR処理に特化
│   ├── json-validator.ts
│   └── rate-limiter.ts
└── types/
    └── layout-types.ts         # 更新：Plant.descriptionText追加
```

### エラーハンドリング

- **パターンマッチング失敗**: 従来のGemini全体解析にフォールバック
- **OCR失敗**: `"name": "unknown"`, `"descriptionText": ""`として出力
- **API呼び出し失敗**: リトライ機能（最大3回）
- **不正なJSON応答**: エラーログ出力後、該当ファイルをスキップ
- **ファイルI/Oエラー**: エラーログ出力後、処理継続

### バリデーション仕様

- 必須フィールド：`page`, `plants`
- `plants`は配列で、各要素は`name`, `photoAreas`, `descriptionAreas`, `descriptionText`を含む
- 座標は正の数値のみ許可
- 空配列は許可（写真や説明がない場合）

## 5. テスト要件

### 単体テスト

- パターンマッチング機能のテスト
- エッジ検出アルゴリズムのテスト
- 画像分割機能のテスト
- OCR機能のテスト
- JSON バリデーション機能のテスト
- レート制限機能のテスト
- ファイルスキップ機能のテスト

### 統合テスト

- Gemini API モックを使用した全体フローテスト
- 実際のPNGファイルを使用したE2Eテスト
- パターン別の処理確認テスト

## 6. 成功基準

- 全PNGファイルが正常に解析される
- パターンマッチング精度が95%以上
- 植物名抽出精度が90%以上
- 出力JSONが仕様に準拠している
- 処理済みファイルが適切にスキップされる
- レート制限が遵守される

## 7. リスク・制約

### 技術的リスク

- エッジ検出の精度・閾値調整の複雑さ
- レイアウトパターンの変動への対応
- OCR精度の変動
- Gemini API の利用制限・コスト
- ネットワークエラー

### 制約事項

- Google Gemini API の利用規約に準拠
- レート制限内での処理
- 図鑑のレイアウト変更への依存
- 3つの固定パターンのみ対応

## 8. パフォーマンス要件

- 1ファイルあたりの処理時間: 5秒以内（エッジ検出+OCR込み）
- メモリ使用量: 500MB以内
- API呼び出し頻度: 2秒間隔（レート制限遵守）